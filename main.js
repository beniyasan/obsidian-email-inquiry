/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var z=Object.create;var _=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var K=(g,e)=>()=>(e||g((e={exports:{}}).exports,e),e.exports),U=(g,e)=>{for(var t in e)_(g,t,{get:e[t],enumerable:!0})},M=(g,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of B(e))!H.call(g,r)&&r!==t&&_(g,r,{get:()=>e[r],enumerable:!(i=q(e,r))||i.enumerable});return g};var N=(g,e,t)=>(t=g!=null?z(W(g)):{},M(e||!g||!g.__esModule?_(t,"default",{value:g,enumerable:!0}):t,g)),G=g=>M(_({},"__esModule",{value:!0}),g);var O=K((fe,Q)=>{Q.exports={commands:{capture_email:"Capture Email",generate_daily_summary:"Generate Daily Summary",search_knowledge_base:"Search Knowledge Base",bulk_import_emails:"Bulk Import Emails"},ribbon:{capture_email:"Capture Email"},modal:{capture_email:{title:"Capture Email Inquiry",sender_email:"Sender Email",sender_name:"Sender Name",subject:"Subject",category:"Category",priority:"Priority",tags:"Tags",email_content:"Email Content",capture_button:"Capture Email",cancel_button:"Cancel",placeholder:{sender_email:"customer@example.com",sender_name:"John Customer (optional)",subject:"Login Issue - Cannot Access Dashboard",tags:"login-issue, dashboard, urgent",email_content:"Paste email content here..."},validation:{sender_email_required:"Sender email is required",sender_email_invalid:"Please enter a valid email address",subject_required:"Subject is required",content_required:"Email content is required"}}},categories:{specification:"Specification",issue:"Issue",migration_vup:"Migration/VUP",other:"Other"},priorities:{low:"Low",medium:"Medium",high:"High",urgent:"Urgent"},settings:{title:"Email Inquiry Management",folders:{title:"Folder Settings",emails_folder:"Emails Folder",summaries_folder:"Summaries Folder",knowledge_folder:"Knowledge Folder",emails_folder_desc:"Folder where captured emails will be stored",summaries_folder_desc:"Folder where daily summaries will be saved",knowledge_folder_desc:"Folder where extracted knowledge will be stored"},categories:{title:"Custom Categories",add_category:"Add Custom Category",add_category_desc:"Create a new category for email classification",add_button:"Add",category_placeholder:"Enter category name...",no_custom_categories:"No custom categories defined. Add categories to extend the default options.",manage_desc:"Click the \xD7 button to delete a category. This will not affect existing emails.",delete_confirm:"Are you sure you want to delete the category '{{category}}'? This action cannot be undone.",delete_tooltip:"Delete this category"},defaults:{title:"Default Values",category:"Default Category",priority:"Default Priority",category_desc:"Default category for new emails",priority_desc:"Default priority for new emails"},automation:{title:"Automation Settings",auto_summary:"Auto-generate Daily Summaries",auto_knowledge:"Auto-extract Knowledge",enable_notifications:"Enable Notifications",auto_summary_desc:"Automatically generate daily summaries",auto_knowledge_desc:"Automatically extract knowledge from resolved emails",enable_notifications_desc:"Show notifications for plugin actions"},advanced:{title:"Advanced Settings",max_attachment_size:"Max Attachment Size (MB)",language:"Language",max_attachment_size_desc:"Maximum file size for attachments",language_desc:"Plugin interface language"}},notices:{email_captured:"Email captured: {{path}}",generating_summary:"Generating daily summary for {{date}}...",summary_generated:"Daily summary generated successfully",summary_generated_with_path:"Daily summary generated ({{count}} emails): {{path}}",error_generating_summary:"Error generating summary: {{error}}",knowledge_search_coming_soon:"Knowledge search coming soon...",bulk_import_coming_soon:"Bulk import coming soon...",settings_saved:"Settings saved successfully"},languages:{en:"English",ja:"\u65E5\u672C\u8A9E"}}});var V=K((we,J)=>{J.exports={commands:{capture_email:"\u30E1\u30FC\u30EB\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",generate_daily_summary:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u3092\u751F\u6210",search_knowledge_base:"\u77E5\u8B58\u30D9\u30FC\u30B9\u3092\u691C\u7D22",bulk_import_emails:"\u30E1\u30FC\u30EB\u306E\u4E00\u62EC\u30A4\u30F3\u30DD\u30FC\u30C8"},ribbon:{capture_email:"\u30E1\u30FC\u30EB\u3092\u30AD\u30E3\u30D7\u30C1\u30E3"},modal:{capture_email:{title:"\u30E1\u30FC\u30EB\u554F\u3044\u5408\u308F\u305B\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",sender_email:"\u9001\u4FE1\u8005\u30E1\u30FC\u30EB",sender_name:"\u9001\u4FE1\u8005\u540D",subject:"\u4EF6\u540D",category:"\u30AB\u30C6\u30B4\u30EA",priority:"\u512A\u5148\u5EA6",tags:"\u30BF\u30B0",email_content:"\u30E1\u30FC\u30EB\u5185\u5BB9",capture_button:"\u30E1\u30FC\u30EB\u3092\u30AD\u30E3\u30D7\u30C1\u30E3",cancel_button:"\u30AD\u30E3\u30F3\u30BB\u30EB",placeholder:{sender_email:"customer@example.com",sender_name:"\u7530\u4E2D\u592A\u90CE\uFF08\u4EFB\u610F\uFF09",subject:"\u30ED\u30B0\u30A4\u30F3\u554F\u984C - \u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9\u306B\u30A2\u30AF\u30BB\u30B9\u3067\u304D\u307E\u305B\u3093",tags:"\u30ED\u30B0\u30A4\u30F3\u554F\u984C, \u30C0\u30C3\u30B7\u30E5\u30DC\u30FC\u30C9, \u7DCA\u6025",email_content:"\u30E1\u30FC\u30EB\u5185\u5BB9\u3092\u3053\u3053\u306B\u8CBC\u308A\u4ED8\u3051\u3066\u304F\u3060\u3055\u3044..."},validation:{sender_email_required:"\u9001\u4FE1\u8005\u30E1\u30FC\u30EB\u306F\u5FC5\u9808\u3067\u3059",sender_email_invalid:"\u6709\u52B9\u306A\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044",subject_required:"\u4EF6\u540D\u306F\u5FC5\u9808\u3067\u3059",content_required:"\u30E1\u30FC\u30EB\u5185\u5BB9\u306F\u5FC5\u9808\u3067\u3059"}}},categories:{specification:"\u4ED5\u69D8",issue:"\u969C\u5BB3",migration_vup:"\u79FB\u884C/VUP",other:"\u305D\u306E\u4ED6"},priorities:{low:"\u4F4E",medium:"\u4E2D",high:"\u9AD8",urgent:"\u7DCA\u6025"},settings:{title:"\u30E1\u30FC\u30EB\u554F\u3044\u5408\u308F\u305B\u7BA1\u7406",folders:{title:"\u30D5\u30A9\u30EB\u30C0\u8A2D\u5B9A",emails_folder:"\u30E1\u30FC\u30EB\u30D5\u30A9\u30EB\u30C0",summaries_folder:"\u30B5\u30DE\u30EA\u30FC\u30D5\u30A9\u30EB\u30C0",knowledge_folder:"\u30CA\u30EC\u30C3\u30B8\u30D5\u30A9\u30EB\u30C0",emails_folder_desc:"\u30AD\u30E3\u30D7\u30C1\u30E3\u3057\u305F\u30E1\u30FC\u30EB\u3092\u4FDD\u5B58\u3059\u308B\u30D5\u30A9\u30EB\u30C0",summaries_folder_desc:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u3092\u4FDD\u5B58\u3059\u308B\u30D5\u30A9\u30EB\u30C0",knowledge_folder_desc:"\u62BD\u51FA\u3057\u305F\u30CA\u30EC\u30C3\u30B8\u3092\u4FDD\u5B58\u3059\u308B\u30D5\u30A9\u30EB\u30C0"},categories:{title:"\u30AB\u30B9\u30BF\u30E0\u30AB\u30C6\u30B4\u30EA",add_category:"\u30AB\u30B9\u30BF\u30E0\u30AB\u30C6\u30B4\u30EA\u3092\u8FFD\u52A0",add_category_desc:"\u30E1\u30FC\u30EB\u5206\u985E\u7528\u306E\u65B0\u3057\u3044\u30AB\u30C6\u30B4\u30EA\u3092\u4F5C\u6210",add_button:"\u8FFD\u52A0",category_placeholder:"\u30AB\u30C6\u30B4\u30EA\u540D\u3092\u5165\u529B...",no_custom_categories:"\u30AB\u30B9\u30BF\u30E0\u30AB\u30C6\u30B4\u30EA\u304C\u5B9A\u7FA9\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u30C7\u30D5\u30A9\u30EB\u30C8\u30AA\u30D7\u30B7\u30E7\u30F3\u3092\u62E1\u5F35\u3059\u308B\u305F\u3081\u306B\u30AB\u30C6\u30B4\u30EA\u3092\u8FFD\u52A0\u3057\u3066\u304F\u3060\u3055\u3044\u3002",manage_desc:"\xD7\u30DC\u30BF\u30F3\u3092\u30AF\u30EA\u30C3\u30AF\u3057\u3066\u30AB\u30C6\u30B4\u30EA\u3092\u524A\u9664\u3067\u304D\u307E\u3059\u3002\u65E2\u5B58\u306E\u30E1\u30FC\u30EB\u306B\u306F\u5F71\u97FF\u3057\u307E\u305B\u3093\u3002",delete_confirm:"\u30AB\u30C6\u30B4\u30EA '{{category}}' \u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F\u3053\u306E\u64CD\u4F5C\u306F\u5143\u306B\u623B\u305B\u307E\u305B\u3093\u3002",delete_tooltip:"\u3053\u306E\u30AB\u30C6\u30B4\u30EA\u3092\u524A\u9664"},defaults:{title:"\u30C7\u30D5\u30A9\u30EB\u30C8\u5024",category:"\u30C7\u30D5\u30A9\u30EB\u30C8\u30AB\u30C6\u30B4\u30EA",priority:"\u30C7\u30D5\u30A9\u30EB\u30C8\u512A\u5148\u5EA6",category_desc:"\u65B0\u3057\u3044\u30E1\u30FC\u30EB\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u30AB\u30C6\u30B4\u30EA",priority_desc:"\u65B0\u3057\u3044\u30E1\u30FC\u30EB\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u512A\u5148\u5EA6"},automation:{title:"\u81EA\u52D5\u5316\u8A2D\u5B9A",auto_summary:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u306E\u81EA\u52D5\u751F\u6210",auto_knowledge:"\u30CA\u30EC\u30C3\u30B8\u306E\u81EA\u52D5\u62BD\u51FA",enable_notifications:"\u901A\u77E5\u3092\u6709\u52B9\u5316",auto_summary_desc:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u3092\u81EA\u52D5\u7684\u306B\u751F\u6210\u3057\u307E\u3059",auto_knowledge_desc:"\u89E3\u6C7A\u6E08\u307F\u30E1\u30FC\u30EB\u304B\u3089\u30CA\u30EC\u30C3\u30B8\u3092\u81EA\u52D5\u62BD\u51FA\u3057\u307E\u3059",enable_notifications_desc:"\u30D7\u30E9\u30B0\u30A4\u30F3\u306E\u52D5\u4F5C\u306B\u5BFE\u3057\u3066\u901A\u77E5\u3092\u8868\u793A\u3057\u307E\u3059"},advanced:{title:"\u8A73\u7D30\u8A2D\u5B9A",max_attachment_size:"\u6700\u5927\u6DFB\u4ED8\u30D5\u30A1\u30A4\u30EB\u30B5\u30A4\u30BA (MB)",language:"\u8A00\u8A9E",max_attachment_size_desc:"\u6DFB\u4ED8\u30D5\u30A1\u30A4\u30EB\u306E\u6700\u5927\u30B5\u30A4\u30BA",language_desc:"\u30D7\u30E9\u30B0\u30A4\u30F3\u30A4\u30F3\u30BF\u30FC\u30D5\u30A7\u30FC\u30B9\u306E\u8A00\u8A9E"}},notices:{email_captured:"\u30E1\u30FC\u30EB\u3092\u30AD\u30E3\u30D7\u30C1\u30E3\u3057\u307E\u3057\u305F: {{path}}",generating_summary:"{{date}}\u306E\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u3092\u751F\u6210\u4E2D...",summary_generated:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u304C\u6B63\u5E38\u306B\u751F\u6210\u3055\u308C\u307E\u3057\u305F",summary_generated_with_path:"\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u304C\u751F\u6210\u3055\u308C\u307E\u3057\u305F ({{count}}\u4EF6): {{path}}",error_generating_summary:"\u30B5\u30DE\u30EA\u30FC\u751F\u6210\u30A8\u30E9\u30FC: {{error}}",knowledge_search_coming_soon:"\u77E5\u8B58\u691C\u7D22\u6A5F\u80FD\u306F\u8FD1\u65E5\u516C\u958B\u4E88\u5B9A\u3067\u3059...",bulk_import_coming_soon:"\u4E00\u62EC\u30A4\u30F3\u30DD\u30FC\u30C8\u6A5F\u80FD\u306F\u8FD1\u65E5\u516C\u958B\u4E88\u5B9A\u3067\u3059...",settings_saved:"\u8A2D\u5B9A\u304C\u6B63\u5E38\u306B\u4FDD\u5B58\u3055\u308C\u307E\u3057\u305F"},languages:{en:"English",ja:"\u65E5\u672C\u8A9E"}}});var Z={};U(Z,{default:()=>I});module.exports=G(Z);var p=require("obsidian");var E=class g{constructor(e){this.data=e}static create(e){let t=this.generateId(),i=new Date,r={id:t,sender:e.sender,senderName:e.senderName,subject:e.subject,body:e.body,receivedDate:e.receivedDate,status:"pending",tags:e.tags||[],category:e.category,priority:e.priority,attachments:e.attachments,rawContent:e.rawContent,createdAt:i,updatedAt:i};return new g(r)}get id(){return this.data.id}get sender(){return this.data.sender}get senderName(){return this.data.senderName}get subject(){return this.data.subject}get body(){return this.data.body}get receivedDate(){return this.data.receivedDate}get status(){return this.data.status}get tags(){return this.data.tags}get category(){return this.data.category}get priority(){return this.data.priority}get attachments(){return this.data.attachments}get relatedEmails(){return this.data.relatedEmails}get knowledgeEntries(){return this.data.knowledgeEntries}get resolutionNoteId(){return this.data.resolutionNoteId}get rawContent(){return this.data.rawContent}get createdAt(){return this.data.createdAt}get updatedAt(){return this.data.updatedAt}updateStatus(e){this.data.status=e,this.data.updatedAt=new Date}addTag(e){this.data.tags.includes(e)||(this.data.tags.push(e),this.data.updatedAt=new Date)}removeTag(e){let t=this.data.tags.indexOf(e);t>-1&&(this.data.tags.splice(t,1),this.data.updatedAt=new Date)}setCategory(e){this.data.category=e,this.data.updatedAt=new Date}setPriority(e){this.data.priority=e,this.data.updatedAt=new Date}linkToKnowledgeEntry(e){this.data.knowledgeEntries||(this.data.knowledgeEntries=[]),this.data.knowledgeEntries.includes(e)||(this.data.knowledgeEntries.push(e),this.data.updatedAt=new Date)}setResolution(e){this.data.resolutionNoteId=e,this.data.status="resolved",this.data.updatedAt=new Date}linkRelatedEmail(e){this.data.relatedEmails||(this.data.relatedEmails=[]),this.data.relatedEmails.includes(e)||(this.data.relatedEmails.push(e),this.data.updatedAt=new Date)}setThreadId(e){this.data.threadId=e,this.data.updatedAt=new Date}validate(){let e=[];return this.data.id||e.push("ID is required"),this.data.sender||e.push("Sender is required"),this.data.subject||e.push("Subject is required"),this.data.body||e.push("Body is required"),this.data.receivedDate||e.push("Received date is required"),this.data.sender&&!this.isValidEmail(this.data.sender)&&e.push("Sender must be a valid email address"),e}isValid(){return this.validate().length===0}toJSON(){return{...this.data}}toFrontmatter(){return{id:this.data.id,sender:this.data.sender,senderName:this.data.senderName,subject:this.data.subject,receivedDate:this.data.receivedDate.toISOString(),status:this.data.status,tags:this.data.tags,category:this.data.category,threadId:this.data.threadId,priority:this.data.priority,attachments:this.data.attachments,relatedEmails:this.data.relatedEmails,knowledgeEntries:this.data.knowledgeEntries,resolutionNoteId:this.data.resolutionNoteId,createdAt:this.data.createdAt.toISOString(),updatedAt:this.data.updatedAt.toISOString()}}static fromJSON(e){let t={...e,receivedDate:new Date(e.receivedDate),createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};return new g(t)}static generateId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}};var b=class{constructor(e,t="Emails",i,r){this.vault=e,this.emailsFolder=t,this.searchIndexer=i,this.knowledgeExtractionService=r}async captureEmail(e){try{this.validateRequest(e);let t=this.createEmailFromRequest(e),i=await this.generateFilePath(t);e.attachments&&e.attachments.length>0&&await this.processAttachments(e.attachments,t.id);let r=this.generateNoteContent(t);await this.vault.create(i,r),this.searchIndexer&&await this.searchIndexer.addEmail(t);let a=null;if(this.knowledgeExtractionService&&this.knowledgeExtractionService.isEligibleForExtraction(t))try{a=await this.knowledgeExtractionService.extractKnowledgeFromEmail(t),console.log("[EmailCapture] Knowledge extracted:",a)}catch(s){console.error("[EmailCapture] Knowledge extraction failed:",s)}return{id:t.id,path:i,message:a?`Email captured successfully. Knowledge extracted to: ${a}`:"Email captured successfully"}}catch(t){throw new Error(`Failed to capture email: ${t instanceof Error?t.message:String(t)}`)}}validateRequest(e){if(!e.sender)throw new Error("Sender is required");if(!e.subject)throw new Error("Subject is required");if(!e.body)throw new Error("Body is required");if(!e.receivedDate)throw new Error("Received date is required");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.sender))throw new Error("Invalid sender email format")}createEmailFromRequest(e){return E.create({sender:e.sender,senderName:e.senderName,subject:e.subject,body:e.body,receivedDate:new Date(e.receivedDate),category:e.category,priority:e.priority||"medium",tags:e.tags||[]})}async generateFilePath(e){let t=e.receivedDate,i=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),s=`${this.emailsFolder}/${i}/${r}`;await this.vault.exists(s)||await this.vault.createFolder(s);let n=this.sanitizeFilename(e.subject),l=t.toTimeString().substring(0,5).replace(":","-"),o=`${a}-${l}-${n}.md`,d=`${s}/${o}`,c=1;for(;await this.vault.exists(d);)o=`${a}-${l}-${n}-${c}.md`,d=`${s}/${o}`,c++;return d}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"-").substring(0,50).toLowerCase()}async processAttachments(e,t){let i=`${this.emailsFolder}/Attachments/${t}`;await this.vault.exists(i)||await this.vault.createFolder(i);for(let r of e)if(r.content){let a=Buffer.from(r.content,"base64"),s=`${i}/${r.filename}`;await this.vault.writeFile(s,a)}}generateNoteContent(e){return["---",this.generateFrontmatter(e),"---","",`# ${e.subject}`,"",`**From:** ${e.senderName||e.sender} <${e.sender}>`,`**Date:** ${e.receivedDate.toISOString()}`,`**Status:** ${e.status}`,...e.category?[`**Category:** ${e.category}`]:[],...e.priority?[`**Priority:** ${e.priority}`]:[],...e.tags.length>0?[`**Tags:** ${e.tags.join(", ")}`]:[],"","## Content","",e.body,"","## Notes","","<!-- Add your notes and resolution details here -->",""].join(`
`)}generateFrontmatter(e){let t=e.toFrontmatter(),i=[];for(let[r,a]of Object.entries(t))a!=null&&(Array.isArray(a)?a.length>0&&(i.push(`${r}:`),a.forEach(s=>i.push(`  - ${s}`))):typeof a=="string"?i.push(`${r}: "${a}"`):i.push(`${r}: ${a}`));return i.join(`
`)}};var R=class g{constructor(e){this.data=e}static create(e){let t=new Date,i=crypto.randomUUID();return new g({id:i,title:e.title,problem:e.problem,solution:e.solution,category:e.category,keywords:e.keywords,sourceEmailId:e.sourceEmailId,tags:e.tags,createdAt:t,updatedAt:t})}get id(){return this.data.id}get title(){return this.data.title}get problem(){return this.data.problem}get solution(){return this.data.solution}get category(){return this.data.category}get keywords(){return this.data.keywords}get sourceEmailId(){return this.data.sourceEmailId}get tags(){return this.data.tags}get createdAt(){return this.data.createdAt}toFrontmatter(){return{id:this.data.id,title:this.data.title,category:this.data.category,keywords:this.data.keywords,sourceEmailId:this.data.sourceEmailId,tags:this.data.tags,createdAt:this.data.createdAt.toISOString(),updatedAt:this.data.updatedAt.toISOString()}}},D=class{constructor(e,t){this.vault=e,this.settings=t}async extractKnowledgeFromEmail(e){if(e.status!=="resolved")return console.log(`[KnowledgeExtraction] Skipping knowledge extraction - email not resolved (status: ${e.status})`),null;if(!this.settings.autoExtractKnowledge)return console.log("[KnowledgeExtraction] Auto-extraction is disabled"),null;try{console.log(`[KnowledgeExtraction] Extracting knowledge from email: ${e.id}`);let t=await this.createKnowledgeEntry(e),i=await this.generateKnowledgeFilePath(t),r=this.generateKnowledgeContent(t,e);return await this.vault.create(i,r),console.log(`[KnowledgeExtraction] Knowledge extracted successfully: ${i}`),i}catch(t){throw console.error(`[KnowledgeExtraction] Failed to extract knowledge from email ${e.id}:`,t),new Error(`Failed to extract knowledge: ${t instanceof Error?t.message:String(t)}`)}}isEligibleForExtraction(e){return this.settings.autoExtractKnowledge&&e.status==="resolved"&&e.body.length>50}async createKnowledgeEntry(e){let t=this.extractProblemStatement(e.body),r=this.extractSolution(e.body,""),a=this.extractKeywords(e);return R.create({title:this.generateKnowledgeTitle(e.subject),problem:t,solution:r,category:e.category,keywords:a,sourceEmailId:e.id,tags:[...e.tags,"auto-extracted"]})}extractProblemStatement(e){let i=e.split(/[.!?]+/).map(a=>a.trim()).filter(a=>a.length>0).filter(a=>/\b(how|what|why|when|where|どう|何|なぜ|いつ|どこ|問題|エラー|できない|わからない)/i.test(a)).slice(0,3);if(i.length>0)return i.join(". ")+".";let r=e.split(`

`)[0];return r.length>200?r.substring(0,200)+"...":r}extractSolution(e,t){if(t&&t.trim().length>10)return t;let r=e.split(/[.!?]+/).map(a=>a.trim()).filter(a=>a.length>0).filter(a=>/\b(解決|修正|対応|fix|resolve|solve|solution|答え|回答|方法)/i.test(a)).slice(0,3);return r.length>0?r.join(". ")+".":"\u89E3\u6C7A\u65B9\u6CD5\u306B\u3064\u3044\u3066\u306F\u8A73\u7D30\u306A\u8ABF\u67FB\u304C\u5FC5\u8981\u3067\u3059\u3002"}extractKeywords(e){let t=`${e.subject} ${e.body}`.toLowerCase(),i=[];return["api","database","server","client","network","security","auth","login","password","error","bug","performance","timeout","\u30C7\u30FC\u30BF\u30D9\u30FC\u30B9","\u30B5\u30FC\u30D0\u30FC","\u30CD\u30C3\u30C8\u30EF\u30FC\u30AF","\u30A8\u30E9\u30FC","\u30D0\u30B0","\u30D1\u30D5\u30A9\u30FC\u30DE\u30F3\u30B9"].forEach(a=>{t.includes(a)&&i.push(a)}),e.category&&i.push(e.category),i.push(...e.tags),[...new Set(i)]}generateKnowledgeTitle(e){let t=e.replace(/^(re:|fwd?:|fw:)\s*/i,"").replace(/\[.*?\]/g,"").trim();return/\b(解決|方法|how\s+to|solution|fix)/i.test(t)||(t=`\u89E3\u6C7A\u65B9\u6CD5: ${t}`),t}async generateKnowledgeFilePath(e){let t=new Date,i=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=`${this.settings.knowledgeFolder}/${i}/${r}`;await this.vault.exists(a)||await this.vault.createFolder(a);let s=this.sanitizeFilename(e.title),n=`${s}.md`,l=`${a}/${n}`,o=1;for(;await this.vault.exists(l);)n=`${s}-${o}.md`,l=`${a}/${n}`,o++;return l}generateKnowledgeContent(e,t){let i=e.toFrontmatter(),r=[];for(let[s,n]of Object.entries(i))n!=null&&(Array.isArray(n)?n.length>0&&(r.push(`${s}:`),n.forEach(l=>r.push(`  - "${l}"`))):typeof n=="string"?r.push(`${s}: "${n}"`):r.push(`${s}: ${n}`));return["---",r.join(`
`),"---","",`# ${e.title}`,"","## \u554F\u984C\u30FB\u8CEA\u554F","",e.problem,"","## \u89E3\u6C7A\u65B9\u6CD5\u30FB\u56DE\u7B54","",e.solution,"","## \u95A2\u9023\u60C5\u5831","",`**\u30AB\u30C6\u30B4\u30EA:** ${e.category||"\u305D\u306E\u4ED6"}`,`**\u30AD\u30FC\u30EF\u30FC\u30C9:** ${e.keywords.join(", ")}`,`**\u5143\u306E\u30E1\u30FC\u30EB:** [[${t.subject}]]`,`**\u4F5C\u6210\u65E5:** ${e.createdAt.toISOString().split("T")[0]}`,"","## \u30E1\u30E2","","<!-- \u8FFD\u52A0\u306E\u60C5\u5831\u3084\u95A2\u9023\u4E8B\u9805\u304C\u3042\u308C\u3070\u8A18\u9332\u3057\u3066\u304F\u3060\u3055\u3044 -->",""].join(`
`)}generateKnowledgeContentWithSourcePath(e,t,i){let r=e.toFrontmatter(),a=[];for(let[l,o]of Object.entries(r))o!=null&&(Array.isArray(o)?o.length>0&&(a.push(`${l}:`),o.forEach(d=>a.push(`  - "${d}"`))):typeof o=="string"?a.push(`${l}: "${o}"`):a.push(`${l}: ${o}`));let s=i.replace(/^\/mnt\/c\/obsidian\//,"").replace(/^C:\\Obsidian\\/,"").replace(/\\/g,"/").replace(/\.md$/,"");return["---",a.join(`
`),"---","",`# ${e.title}`,"","## \u554F\u984C\u30FB\u8CEA\u554F","",e.problem,"","## \u89E3\u6C7A\u65B9\u6CD5\u30FB\u56DE\u7B54","",e.solution,"","## \u95A2\u9023\u60C5\u5831","",`**\u30AB\u30C6\u30B4\u30EA:** ${e.category||"\u305D\u306E\u4ED6"}`,`**\u30AD\u30FC\u30EF\u30FC\u30C9:** ${e.keywords.join(", ")}`,`**\u5143\u306E\u30E1\u30FC\u30EB:** [[${s}|${t.subject}]]`,`**\u4F5C\u6210\u65E5:** ${e.createdAt.toISOString().split("T")[0]}`,"","## \u30E1\u30E2","","<!-- \u8FFD\u52A0\u306E\u60C5\u5831\u3084\u95A2\u9023\u4E8B\u9805\u304C\u3042\u308C\u3070\u8A18\u9332\u3057\u3066\u304F\u3060\u3055\u3044 -->",""].join(`
`)}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"-").substring(0,50).toLowerCase()}updateSettings(e){this.settings=e}async extractKnowledgeFromEmailWithPath(e,t){try{console.log(`[KnowledgeExtraction] Extracting knowledge from email: ${e.id}`);let i=await this.createKnowledgeEntry(e),r=await this.generateKnowledgeFilePath(i),a=this.generateKnowledgeContentWithSourcePath(i,e,t);return await this.vault.create(r,a),console.log(`[KnowledgeExtraction] Knowledge extracted successfully: ${r}`),r}catch(i){throw console.error(`[KnowledgeExtraction] Failed to extract knowledge from email ${e.id}:`,i),new Error(`Failed to extract knowledge: ${i instanceof Error?i.message:String(i)}`)}}async extractKnowledgeFromFile(e){try{console.log(`[KnowledgeExtraction] Extracting knowledge from file: ${e}`);let t=await this.vault.read(e),i=this.parseEmailFile(t,e);if(!i)return console.log(`[KnowledgeExtraction] Failed to parse email file: ${e}`),null;if(console.log("[KnowledgeExtraction] Parsed email data:",JSON.stringify(i,null,2)),i.status!=="resolved")return console.log(`[KnowledgeExtraction] Email not resolved (status: "${i.status}", type: ${typeof i.status})`),null;console.log("[KnowledgeExtraction] Processing resolved email for manual knowledge extraction");let r=this.createEmailModelFromData(i);return await this.extractKnowledgeFromEmailWithPath(r,e)}catch(t){throw console.error(`[KnowledgeExtraction] Failed to extract knowledge from file ${e}:`,t),new Error(`Failed to extract knowledge from file: ${t instanceof Error?t.message:String(t)}`)}}parseEmailFile(e,t){try{let i=e.match(/^---\n([\s\S]*?)\n---/);if(!i)return console.log(`[KnowledgeExtraction] No frontmatter found in ${t}`),null;let r=i[1],a={},s=r.split(`
`);for(let o of s){let d=o.trim();if(!(!d||d.startsWith("#"))){if(d.includes(":")){let c=d.indexOf(":"),h=d.substring(0,c).trim(),u=d.substring(c+1).trim();if(h==="status"&&console.log(`[KnowledgeExtraction] Parsing status - raw value: "${u}"`),(u.startsWith('"')&&u.endsWith('"')||u.startsWith("'")&&u.endsWith("'"))&&(u=u.slice(1,-1),h==="status"&&console.log(`[KnowledgeExtraction] Status after quote removal: "${u}"`)),h==="tags"&&u===""){a[h]=[];continue}a[h]=u,h==="status"&&console.log(`[KnowledgeExtraction] Final status value assigned: "${u}"`)}else if(d.startsWith("- ")){let c=Object.keys(a).pop();c&&Array.isArray(a[c])?a[c].push(d.substring(2).trim()):c&&(a[c]=[d.substring(2).trim()])}}}let n=e.match(/---[\s\S]*?---\n\n([\s\S]*)/),l=n?n[1]:"";return{...a,body:l,receivedDate:a.receivedDate?new Date(a.receivedDate):new Date,tags:a.tags||[]}}catch(i){return console.error(`[KnowledgeExtraction] Error parsing email file ${t}:`,i),null}}createEmailModelFromData(e){let t=E.create({sender:e.sender,senderName:e.senderName,subject:e.subject,body:e.body,receivedDate:e.receivedDate,category:e.category,priority:e.priority||"medium",tags:e.tags||[]});return e.status&&t.updateStatus(e.status),t}};var F=class{constructor(e,t){this.vault=e,this.settings=t}async generateSummary(e){try{console.log(`[DailySummary] Generating summary for date: ${e.date}`);let t=await this.collectEmailsForDate(e.date,e.includePreviousDays||0);if(t.length===0)throw console.log("[DailySummary] No emails found for the specified date"),new Error("\u6307\u5B9A\u3055\u308C\u305F\u65E5\u4ED8\u306B\u30E1\u30FC\u30EB\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093");let i=this.generateStatistics(t),r=this.generateSummaryContent(e.date,t,i),a=await this.generateSummaryFilePath(e.date);return await this.vault.create(a,r),console.log(`[DailySummary] Summary generated successfully: ${a}`),{date:e.date,filePath:a,stats:i,message:`\u65E5\u6B21\u30B5\u30DE\u30EA\u30FC\u3092\u751F\u6210\u3057\u307E\u3057\u305F: ${a}`}}catch(t){throw console.error("[DailySummary] Failed to generate summary:",t),new Error(`\u30B5\u30DE\u30EA\u30FC\u751F\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${t instanceof Error?t.message:String(t)}`)}}async collectEmailsForDate(e,t=0){let i=[],r=new Date(e),a=new Date(r);a.setDate(a.getDate()-t),console.log(`[DailySummary] Collecting emails from ${a.toISOString().split("T")[0]} to ${e}`);try{let s=new Date(a);for(;s<=r;){let n=s.getFullYear(),l=String(s.getMonth()+1).padStart(2,"0"),o=`${this.settings.emailsFolder}/${n}/${l}`;if(await this.vault.exists(o)){let d=await this.collectEmailsFromFolder(o,s);i.push(...d)}s.setDate(s.getDate()+1)}}catch(s){console.error("[DailySummary] Error collecting emails:",s)}return console.log(`[DailySummary] Collected ${i.length} emails`),i}async collectEmailsFromFolder(e,t){let i=[],r=t.toISOString().split("T")[0],a=String(t.getDate()).padStart(2,"0");try{if(console.log(`[DailySummary] Scanning folder: ${e} for date: ${r}`),!await this.vault.exists(e))return console.log(`[DailySummary] Folder ${e} does not exist`),i;let n=(await this.vault.list(e)).filter(l=>l.endsWith(".md"));console.log(`[DailySummary] Found ${n.length} markdown files in ${e}`);for(let l of n){let o=l.split("/").pop()||"";if(o.endsWith(".md")&&o.startsWith(`${a}-`)){console.log(`[DailySummary] Processing email file: ${o}`);try{let d=await this.vault.read(l),c=this.parseEmailFile(d,l);c&&i.push(c)}catch(d){console.error(`[DailySummary] Error reading file ${o}:`,d)}}}}catch(s){console.error(`[DailySummary] Error reading folder ${e}:`,s)}return console.log(`[DailySummary] Collected ${i.length} emails from ${e}`),i}parseEmailFile(e,t){try{let i=e.match(/^---\n([\s\S]*?)\n---/);if(!i)return console.log(`[DailySummary] No frontmatter found in ${t}`),null;let r=i[1],a={},s=r.split(`
`);for(let n of s){let l=n.trim();if(!(!l||l.startsWith("#"))){if(l.includes(":")){let o=l.indexOf(":"),d=l.substring(0,o).trim(),c=l.substring(o+1).trim();if((c.startsWith('"')&&c.endsWith('"')||c.startsWith("'")&&c.endsWith("'"))&&(c=c.slice(1,-1)),d==="tags"&&c===""){a[d]=[];continue}a[d]=c}else if(l.startsWith("- ")){let o=Object.keys(a).pop();o&&Array.isArray(a[o])?a[o].push(l.substring(2).trim()):o&&(a[o]=[l.substring(2).trim()])}}}return!a.id||!a.sender||!a.subject?(console.log(`[DailySummary] Missing required fields in ${t}`),null):{id:a.id,sender:a.sender,senderName:a.senderName||void 0,subject:a.subject,category:a.category||void 0,priority:a.priority||void 0,status:a.status,receivedDate:new Date(a.receivedDate),tags:a.tags||[]}}catch(i){return console.error(`[DailySummary] Error parsing email file ${t}:`,i),null}}generateStatistics(e){let t={totalEmails:e.length,byCategory:{},byPriority:{},byStatus:{},topSenders:[],commonTags:[]},i={},r={};return e.forEach(a=>{let s=a.category||"\u305D\u306E\u4ED6";t.byCategory[s]=(t.byCategory[s]||0)+1;let n=a.priority||"medium";t.byPriority[n]=(t.byPriority[n]||0)+1,t.byStatus[a.status]=(t.byStatus[a.status]||0)+1,i[a.sender]||(i[a.sender]={name:a.senderName,count:0}),i[a.sender].count++,a.tags.forEach(l=>{r[l]=(r[l]||0)+1})}),t.topSenders=Object.entries(i).map(([a,s])=>({email:a,name:s.name,count:s.count})).sort((a,s)=>s.count-a.count).slice(0,10),t.commonTags=Object.entries(r).map(([a,s])=>({tag:a,count:s})).sort((a,s)=>s.count-a.count).slice(0,15),t}generateSummaryContent(e,t,i){let r=new Date(e),a=this.settings.language==="ja"?`${r.getFullYear()}\u5E74${r.getMonth()+1}\u6708${r.getDate()}\u65E5`:r.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),s={date:e,type:"daily-summary",totalEmails:i.totalEmails,createdAt:new Date().toISOString(),language:this.settings.language},n=[];for(let[o,d]of Object.entries(s))typeof d=="string"?n.push(`${o}: "${d}"`):n.push(`${o}: ${d}`);return["---",n.join(`
`),"---","",`# \u{1F4E7} ${a} \u30E1\u30FC\u30EB\u554F\u3044\u5408\u308F\u305B\u30B5\u30DE\u30EA\u30FC`,"","## \u{1F4CA} \u6982\u8981","",`- **\u7DCF\u30E1\u30FC\u30EB\u6570**: ${i.totalEmails}\u4EF6`,`- **\u751F\u6210\u65E5\u6642**: ${new Date().toLocaleString("ja-JP")}`,"","## \u{1F4C8} \u7D71\u8A08\u60C5\u5831","","### \u30AB\u30C6\u30B4\u30EA\u5225","",...this.generateStatTable(i.byCategory,this.getCategoryDisplayName.bind(this)),"","### \u512A\u5148\u5EA6\u5225","",...this.generateStatTable(i.byPriority,this.getPriorityDisplayName.bind(this)),"","### \u30B9\u30C6\u30FC\u30BF\u30B9\u5225","",...this.generateStatTable(i.byStatus,this.getStatusDisplayName.bind(this)),"","## \u{1F465} \u9001\u4FE1\u8005\u5206\u6790","",...i.topSenders.length>0?["| \u9001\u4FE1\u8005 | \u4EF6\u6570 |","|--------|------|",...i.topSenders.map(o=>`| ${o.name||o.email} | ${o.count}\u4EF6 |`)]:["\u9001\u4FE1\u8005\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u305B\u3093\u3002"],"","## \u{1F3F7}\uFE0F \u3088\u304F\u4F7F\u308F\u308C\u305F\u30BF\u30B0","",...i.commonTags.length>0?[i.commonTags.slice(0,10).map(o=>`- **${o.tag}** (${o.count}\u4EF6)`).join(`
`)]:["\u30BF\u30B0\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u305B\u3093\u3002"],"","## \u{1F4CB} \u8A73\u7D30\u30E1\u30FC\u30EB\u4E00\u89A7","",...t.length>0?["| \u6642\u523B | \u9001\u4FE1\u8005 | \u4EF6\u540D | \u30AB\u30C6\u30B4\u30EA | \u30B9\u30C6\u30FC\u30BF\u30B9 |","|------|--------|------|----------|------------|",...t.slice(0,50).map(o=>{let d=o.receivedDate.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}),c=o.senderName||o.sender,h=o.subject.length>30?o.subject.substring(0,30)+"...":o.subject,u=this.getCategoryDisplayName(o.category||""),m=this.getStatusDisplayName(o.status);return`| ${d} | ${c} | ${h} | ${u} | ${m} |`}),...t.length>50?[`
*...\u4ED6${t.length-50}\u4EF6*`]:[]]:["\u30E1\u30FC\u30EB\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u305B\u3093\u3002"],"","## \u{1F4A1} \u30A4\u30F3\u30B5\u30A4\u30C8","",...this.generateInsights(i),"","---","","> \u3053\u306E\u30B5\u30DE\u30EA\u30FC\u306F\u81EA\u52D5\u751F\u6210\u3055\u308C\u307E\u3057\u305F\u3002","> \u751F\u6210\u5143: Email Inquiry Management Plugin v1.0.0",""].join(`
`)}generateStatTable(e,t){return Object.keys(e).length===0?["\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u305B\u3093\u3002"]:["| \u9805\u76EE | \u4EF6\u6570 | \u5272\u5408 |","|------|------|------|",...Object.entries(e).sort(([,r],[,a])=>a-r).map(([r,a])=>{let s=Object.values(e).reduce((l,o)=>l+o,0),n=s>0?Math.round(a/s*100):0;return`| ${t(r)} | ${a}\u4EF6 | ${n}% |`})]}generateInsights(e){let t=[];e.totalEmails>20?t.push("\u{1F525} **\u9AD8\u3044\u554F\u3044\u5408\u308F\u305B\u91CF**: \u4ECA\u65E5\u306F\u901A\u5E38\u3088\u308A\u591A\u304F\u306E\u554F\u3044\u5408\u308F\u305B\u304C\u3042\u308A\u307E\u3057\u305F\u3002"):e.totalEmails<5&&t.push("\u{1F4C9} **\u4F4E\u3044\u554F\u3044\u5408\u308F\u305B\u91CF**: \u4ECA\u65E5\u306F\u6BD4\u8F03\u7684\u9759\u304B\u306A\u4E00\u65E5\u3067\u3057\u305F\u3002");let i=Object.entries(e.byCategory).sort(([,l],[,o])=>o-l)[0];i&&i[1]>e.totalEmails*.4&&t.push(`\u{1F4C2} **\u4E3B\u8981\u30AB\u30C6\u30B4\u30EA**: ${this.getCategoryDisplayName(i[0])}\u306E\u554F\u3044\u5408\u308F\u305B\u304C\u591A\u304F\u3092\u5360\u3081\u3066\u3044\u307E\u3059 (${i[1]}\u4EF6)\u3002`);let r=e.byPriority.high||0,a=e.byPriority.urgent||0;r+a>e.totalEmails*.3&&t.push("\u26A0\uFE0F **\u512A\u5148\u5EA6\u9AD8**: \u7DCA\u6025\u6027\u306E\u9AD8\u3044\u554F\u3044\u5408\u308F\u305B\u304C\u591A\u304F\u898B\u3064\u304B\u308A\u307E\u3057\u305F\u3002\u65E9\u6025\u306A\u5BFE\u5FDC\u304C\u5FC5\u8981\u3067\u3059\u3002");let s=e.byStatus.resolved||0,n=e.totalEmails>0?Math.round(s/e.totalEmails*100):0;return n>80?t.push(`\u2705 **\u9AD8\u89E3\u6C7A\u7387**: \u89E3\u6C7A\u7387${n}%\u3068\u9AD8\u3044\u30D1\u30D5\u30A9\u30FC\u30DE\u30F3\u30B9\u3092\u793A\u3057\u3066\u3044\u307E\u3059\u3002`):n<30&&t.push(`\u{1F4CB} **\u8981\u30D5\u30A9\u30ED\u30FC\u30A2\u30C3\u30D7**: \u89E3\u6C7A\u7387${n}%\u3068\u4F4E\u304F\u3001\u672A\u89E3\u6C7A\u306E\u554F\u3044\u5408\u308F\u305B\u304C\u591A\u304F\u6B8B\u3063\u3066\u3044\u307E\u3059\u3002`),e.topSenders.length>0&&e.topSenders[0].count>3&&t.push(`\u{1F464} **\u983B\u51FA\u9001\u4FE1\u8005**: ${e.topSenders[0].name||e.topSenders[0].email}\u304B\u3089${e.topSenders[0].count}\u4EF6\u306E\u554F\u3044\u5408\u308F\u305B\u304C\u3042\u308A\u307E\u3057\u305F\u3002`),t.length===0&&t.push("\u{1F4DD} \u7279\u306B\u6CE8\u76EE\u3059\u3079\u304D\u50BE\u5411\u306F\u898B\u3089\u308C\u307E\u305B\u3093\u3067\u3057\u305F\u3002"),t}getCategoryDisplayName(e){return{specification:"\u4ED5\u69D8",issue:"\u969C\u5BB3",migration_vup:"\u79FB\u884C/VUP",other:"\u305D\u306E\u4ED6"}[e]||e||"\u305D\u306E\u4ED6"}getPriorityDisplayName(e){return{low:"\u4F4E",medium:"\u4E2D",high:"\u9AD8",urgent:"\u7DCA\u6025"}[e]||e||"\u4E2D"}getStatusDisplayName(e){return{pending:"\u672A\u5BFE\u5FDC",in_progress:"\u5BFE\u5FDC\u4E2D",resolved:"\u89E3\u6C7A\u6E08\u307F",archived:"\u30A2\u30FC\u30AB\u30A4\u30D6"}[e]||e||"\u672A\u5BFE\u5FDC"}async generateSummaryFilePath(e){let i=new Date(e).getFullYear();await this.vault.exists(this.settings.summariesFolder)||await this.vault.createFolder(this.settings.summariesFolder);let r=`${this.settings.summariesFolder}/${i}`;await this.vault.exists(r)||await this.vault.createFolder(r);let a=`${e}-daily-summary.md`,s=`${r}/${a}`,n=1;for(;await this.vault.exists(s);){let l=`${e}-daily-summary-${n}.md`;s=`${r}/${l}`,n++}return s}updateSettings(e){this.settings=e}};var C=class{constructor(e,t){this.vault=e;this.settings=t;this.searchIndex=new Map;this.lastIndexUpdate=null;this.indexingInProgress=!1;this.searchCache=new Map;this.CACHE_TIMEOUT=300*1e3;this.DEFAULT_LIMIT=50;this.MIN_RELEVANCE_SCORE=10}async initialize(){console.log("[KnowledgeSearch] Initializing search service..."),await this.buildSearchIndex()}async search(e,t){if(console.log("[KnowledgeSearch] Searching with query:",e),this.settings.enableCache!==!1&&t?.enableCache!==!1){let r=this.getCacheKey(e),a=this.searchCache.get(r);if(a&&Date.now()-a.timestamp<this.CACHE_TIMEOUT)return console.log("[KnowledgeSearch] Returning cached results"),a.results}(!this.lastIndexUpdate||this.isIndexStale())&&await this.buildSearchIndex();let i=await this.performSearch(e,t);if(this.settings.enableCache!==!1){let r=this.getCacheKey(e);this.searchCache.set(r,{results:i,timestamp:Date.now()})}return i}async buildSearchIndex(){if(this.indexingInProgress){console.log("[KnowledgeSearch] Indexing already in progress, skipping...");return}this.indexingInProgress=!0,console.log("[KnowledgeSearch] Building search index...");try{let e=this.vault.getFolderPath(this.settings.knowledgeFolder);if(!await this.vault.exists(e)){console.log("[KnowledgeSearch] Knowledge folder does not exist:",e),this.searchIndex.clear();return}let i=(await this.vault.list(e)).filter(r=>r.endsWith(".md"));console.log(`[KnowledgeSearch] Found ${i.length} knowledge files`),this.searchIndex.clear();for(let r of i)try{let a=await this.indexFile(r);a&&this.searchIndex.set(a.id,a)}catch(a){console.error(`[KnowledgeSearch] Error indexing file ${r}:`,a)}this.lastIndexUpdate=new Date,console.log(`[KnowledgeSearch] Index built with ${this.searchIndex.size} entries`)}finally{this.indexingInProgress=!1}}async indexFile(e){try{let t=await this.vault.read(e),{frontmatter:i,body:r}=this.parseFrontmatter(t);return i.id?{id:i.id,filePath:e,title:i.title||this.extractTitle(r),content:r,problem:this.extractSection(r,"\u554F\u984C\u30FB\u8CEA\u554F")||"",solution:this.extractSection(r,"\u89E3\u6C7A\u65B9\u6CD5\u30FB\u56DE\u7B54")||"",category:i.category||"\u305D\u306E\u4ED6",tags:Array.isArray(i.tags)?i.tags:[],keywords:Array.isArray(i.keywords)?i.keywords:[],priority:i.priority,sourceEmailId:i.sourceEmailId,createdAt:i.createdAt?new Date(i.createdAt):new Date,updatedAt:i.updatedAt?new Date(i.updatedAt):new Date,lastIndexed:new Date}:(console.warn(`[KnowledgeSearch] No ID found in file: ${e}`),null)}catch(t){return console.error(`[KnowledgeSearch] Error reading file ${e}:`,t),null}}async performSearch(e,t){let i=Date.now(),r=[];for(let l of this.searchIndex.values()){if(!this.matchesFilters(l,e))continue;let o=this.calculateRelevanceScore(l,e);if(o<(t?.minRelevanceScore||this.MIN_RELEVANCE_SCORE))continue;let d=this.createSearchResult(l,e,o);r.push(d)}r.sort((l,o)=>o.relevanceScore-l.relevanceScore);let a=e.limit||t?.maxResults||this.settings.maxResults||this.DEFAULT_LIMIT,s=r.slice(0,a),n=Date.now()-i;return console.log(`[KnowledgeSearch] Search completed in ${n}ms, found ${s.length} results`),s}matchesFilters(e,t){if(t.categories&&t.categories.length>0&&!t.categories.includes(e.category)||t.tags&&t.tags.length>0&&!t.tags.some(r=>e.tags.includes(r)))return!1;if(t.dateRange){let i=e.createdAt;if(i<t.dateRange.from||i>t.dateRange.to)return!1}return!(t.priority&&t.priority.length>0&&(!e.priority||!t.priority.includes(e.priority)))}calculateRelevanceScore(e,t){if(!t.query||t.query.trim()==="")return 50;let i=this.tokenizeQuery(t.query.toLowerCase()),r=0,a=new Set,s={title:10,keywords:8,problem:6,solution:6,tags:5,content:3,category:2},n=t.searchIn||["all"];for(let[d,c]of Object.entries(s)){if(!n.includes("all")&&!n.includes(d))continue;let h=this.getFieldValue(e,d);if(!h)continue;let u=h.toLowerCase(),m=0;for(let v of i)if(t.fuzzy){let x=this.calculateSimilarity(u,v);x>.7&&(m+=c*x,a.add(d))}else u.includes(v)&&(m+=c,a.add(d),new RegExp(`\\b${v}\\b`,"i").test(u)&&(m+=c*.5));r+=m}let l=Object.values(s).reduce((d,c)=>d+c,0)*i.length,o=Math.min(100,r/l*100);return Math.round(o)}createSearchResult(e,t,i){let r=this.generateHighlights(e,t),a=this.generateExcerpt(e,t,r);return{id:e.id,title:e.title,excerpt:a,filePath:e.filePath,category:e.category,tags:e.tags,relevanceScore:i,matchedFields:[...new Set(r.map(s=>s.field))],highlights:r,createdAt:e.createdAt,updatedAt:e.updatedAt}}generateHighlights(e,t){let i=[];if(!t.query)return i;let r=this.tokenizeQuery(t.query.toLowerCase()),a=["title","problem","solution","content"];for(let s of a){let n=this.getFieldValue(e,s);if(n)for(let l of r){let o=new RegExp(`(${this.escapeRegex(l)})`,"gi"),d=n.matchAll(o);for(let c of d)if(c.index!==void 0){let h=Math.max(0,c.index-50),u=Math.min(n.length,c.index+l.length+50),v=("..."+n.substring(h,u)+"...").replace(o,"<mark>$1</mark>");if(i.push({field:s,snippet:v,position:{start:c.index,end:c.index+l.length}}),i.filter(x=>x.field===s).length>=2)break}}}return i}generateExcerpt(e,t,i){if(i.length>0)return i[0].snippet;let r=e.problem||e.solution||e.content,a=200;return r.length<=a?r:r.substring(0,a)+"..."}getStats(){return{totalResults:this.searchIndex.size,searchTime:0,indexSize:this.searchIndex.size,lastUpdated:this.lastIndexUpdate||new Date}}clearCache(){this.searchCache.clear(),console.log("[KnowledgeSearch] Cache cleared")}updateSettings(e){Object.assign(this.settings,e),this.clearCache()}parseFrontmatter(e){let t=/^---\n([\s\S]*?)\n---\n([\s\S]*)$/,i=e.match(t);if(!i)return{frontmatter:{},body:e};let r=i[1],a=i[2],s={},n=r.split(`
`);for(let l of n){let o=l.indexOf(":");if(o>0){let d=l.substring(0,o).trim(),c=l.substring(o+1).trim();if(c.startsWith('"')&&c.endsWith('"')&&(c=c.slice(1,-1)),c===""){let h=[],u=n.indexOf(l)+1;for(;u<n.length&&n[u].startsWith("  - ");){let m=n[u].substring(4).trim();m.startsWith('"')&&m.endsWith('"')&&(m=m.slice(1,-1)),h.push(m),u++}if(h.length>0){s[d]=h;continue}}s[d]=c}}return{frontmatter:s,body:a}}extractTitle(e){let t=e.match(/^#\s+(.+)$/m);return t?t[1]:"Untitled"}extractSection(e,t){let r=new RegExp(`^##\\s+${this.escapeRegex(t)}\\s*$([\\s\\S]*?)(?=^##\\s|$)`,"gm").exec(e);return r?r[1].trim():""}tokenizeQuery(e){let t=[],i=/[^\s"]+|"([^"]*)"/gi,r;for(;(r=i.exec(e))!==null;)t.push(r[1]||r[0]);return t}getFieldValue(e,t){switch(t){case"title":return e.title;case"content":return e.content;case"problem":return e.problem;case"solution":return e.solution;case"category":return e.category;case"tags":return e.tags.join(" ");case"keywords":return e.keywords.join(" ");default:return""}}calculateSimilarity(e,t){let i=Math.floor(t.length*.3);for(let r=0;r<=e.length-t.length;r++){let a=e.substring(r,r+t.length),s=this.levenshteinDistance(a,t);if(s<=i)return 1-s/t.length}return 0}levenshteinDistance(e,t){let i=[];for(let r=0;r<=t.length;r++)i[r]=[r];for(let r=0;r<=e.length;r++)i[0][r]=r;for(let r=1;r<=t.length;r++)for(let a=1;a<=e.length;a++)t.charAt(r-1)===e.charAt(a-1)?i[r][a]=i[r-1][a-1]:i[r][a]=Math.min(i[r-1][a-1]+1,i[r][a-1]+1,i[r-1][a]+1);return i[t.length][e.length]}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}getCacheKey(e){return JSON.stringify({query:e.query,categories:e.categories?.sort(),tags:e.tags?.sort(),dateRange:e.dateRange,priority:e.priority?.sort(),searchIn:e.searchIn?.sort(),fuzzy:e.fuzzy,limit:e.limit})}isIndexStale(){if(!this.lastIndexUpdate)return!0;let e=600*1e3;return Date.now()-this.lastIndexUpdate.getTime()>e}};var $=class{constructor(){this.translations=new Map;this.currentLanguage="en";this.fallbackLanguage="en";this.detectLanguage()}async initialize(){try{let e=await this.loadTranslationFile("en");this.translations.set("en",e);let t=await this.loadTranslationFile("ja");this.translations.set("ja",t)}catch(e){console.error("Failed to load translations:",e),this.translations.set("en",{}),this.translations.set("ja",{})}}async loadTranslationFile(e){try{if(e==="en"){let t=await Promise.resolve().then(()=>N(O()));return t.default||t}else if(e==="ja"){let t=await Promise.resolve().then(()=>N(V()));return t.default||t}throw new Error(`Unsupported language: ${e}`)}catch(t){return console.error(`Failed to load ${e} translations:`,t),{}}}detectLanguage(){(window.navigator.language||"en").startsWith("ja")?this.currentLanguage="ja":this.currentLanguage="en"}setLanguage(e){this.currentLanguage=e}getCurrentLanguage(){return this.currentLanguage}getAvailableLanguages(){return["en","ja"]}t(e,t){let i=this.getTranslation(e,this.currentLanguage)||this.getTranslation(e,this.fallbackLanguage)||e;return t?this.replaceParams(i,t):i}getTranslation(e,t){let i=this.translations.get(t);if(!i)return null;let r=e.split("."),a=i;for(let s of r)if(a&&typeof a=="object"&&s in a)a=a[s];else return null;return typeof a=="string"?a:null}replaceParams(e,t){return e.replace(/\{\{(\w+)\}\}/g,(i,r)=>t[r]!==void 0?String(t[r]):i)}getTranslationGroup(e){let t=this.translations.get(this.currentLanguage)||{},i=e.split("."),r=t;for(let a of i)if(r&&typeof r=="object"&&a in r)r=r[a];else{let n=this.translations.get(this.fallbackLanguage)||{};for(let l of i)if(n&&typeof n=="object"&&l in n)n=n[l];else return{};r=n;break}return r&&typeof r=="object"?r:{}}};var f=require("obsidian"),T=class{constructor(e,t){this.vault=e;this.fileManager=t}async create(e,t){try{await this.vault.create(e,t)}catch(i){throw new Error(`Failed to create file ${e}: ${i}`)}}async exists(e){try{return this.vault.getAbstractFileByPath(e)!==null}catch{return!1}}async createFolder(e){try{let t=e.split("/"),i="";for(let r of t)i=i?`${i}/${r}`:r,await this.exists(i)||await this.vault.createFolder(i)}catch(t){throw new Error(`Failed to create folder ${e}: ${t}`)}}async writeFile(e,t){try{let i=e.substring(0,e.lastIndexOf("/"));i&&!await this.exists(i)&&await this.createFolder(i);let r;if(t instanceof Buffer){let a=new ArrayBuffer(t.length),s=new Uint8Array(a);for(let n=0;n<t.length;++n)s[n]=t[n];r=a}else r=t;await this.vault.createBinary(e,r)}catch(i){throw new Error(`Failed to write file ${e}: ${i}`)}}async read(e){try{let t=this.vault.getAbstractFileByPath(e);if(!t||!(t instanceof f.TFile))throw new Error(`File not found: ${e}`);return await this.vault.read(t)}catch(t){throw new Error(`Failed to read file ${e}: ${t}`)}}async modify(e,t){try{let i=this.vault.getAbstractFileByPath(e);if(!i||!(i instanceof f.TFile))throw new Error(`File not found: ${e}`);await this.vault.modify(i,t)}catch(i){throw new Error(`Failed to modify file ${e}: ${i}`)}}async delete(e){try{let t=this.vault.getAbstractFileByPath(e);if(!t)throw new Error(`File not found: ${e}`);await this.vault.delete(t)}catch(t){throw new Error(`Failed to delete file ${e}: ${t}`)}}async list(e){try{let t=this.vault.getAbstractFileByPath(e);if(!t||!(t instanceof f.TFolder))return[];let i=[],r=a=>{for(let s of a.children)s instanceof f.TFile?i.push(s.path):s instanceof f.TFolder&&r(s)};return r(t),i}catch(t){throw new Error(`Failed to list folder ${e}: ${t}`)}}getFolderPath(e){return e}async getFiles(e){try{if(e){let t=this.vault.getAbstractFileByPath(e);if(!t||!(t instanceof f.TFolder))return[];let i=[],r=a=>{for(let s of a.children)s instanceof f.TFile?i.push(s):s instanceof f.TFolder&&r(s)};return r(t),i}else return this.vault.getMarkdownFiles()}catch(t){throw new Error(`Failed to get files from ${e}: ${t}`)}}async rename(e,t){try{let i=this.vault.getAbstractFileByPath(e);if(!i)throw new Error(`File not found: ${e}`);await this.fileManager.renameFile(i,t)}catch(i){throw new Error(`Failed to rename ${e} to ${t}: ${i}`)}}async copy(e,t){try{let i=this.vault.getAbstractFileByPath(e);if(!i||!(i instanceof f.TFile))throw new Error(`Source file not found: ${e}`);let r=await this.vault.read(i);await this.create(t,r)}catch(i){throw new Error(`Failed to copy ${e} to ${t}: ${i}`)}}};var w=require("obsidian");var k=class extends w.Modal{constructor(e,t,i,r,a){super(e),this.emailCaptureService=t,this.settings=i,this.i18nService=r,this.onSuccess=a}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:this.i18nService.t("modal.capture_email.title")}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.sender_email")).setDesc("Email address of the person who sent the inquiry").addText(i=>{this.senderInput=i,i.setPlaceholder(this.i18nService.t("modal.capture_email.placeholder.sender_email")).onChange(r=>{this.validateEmail(r)})}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.sender_name")).setDesc("Display name of the sender (optional)").addText(i=>{this.senderNameInput=i,i.setPlaceholder(this.i18nService.t("modal.capture_email.placeholder.sender_name"))}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.subject")).setDesc("Email subject line").addText(i=>{this.subjectInput=i,i.setPlaceholder(this.i18nService.t("modal.capture_email.placeholder.subject"))}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.category")).setDesc("Categorize this inquiry").addDropdown(i=>{this.categoryDropdown=i;let r=this.i18nService.getTranslationGroup("categories");i.addOption("","Select category..."),i.addOption("specification",r.specification).addOption("issue",r.issue).addOption("migration_vup",r.migration_vup).addOption("other",r.other),this.settings.customCategories&&this.settings.customCategories.length>0&&(i.addOption("---","--- Custom Categories ---"),this.settings.customCategories.forEach(a=>{i.addOption(a,a)})),i.setValue(this.settings.defaultCategory)}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.priority")).setDesc("Priority level of this inquiry").addDropdown(i=>{this.priorityDropdown=i;let r=this.i18nService.getTranslationGroup("priorities");i.addOption("low",r.low).addOption("medium",r.medium).addOption("high",r.high).addOption("urgent",r.urgent).setValue(this.settings.defaultPriority)}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.tags")).setDesc("Comma-separated tags for this email").addText(i=>{this.tagsInput=i,i.setPlaceholder(this.i18nService.t("modal.capture_email.placeholder.tags"))}),new w.Setting(e).setName(this.i18nService.t("modal.capture_email.email_content")).setDesc("The main content of the email").addTextArea(i=>{this.bodyInput=i,i.setPlaceholder(this.i18nService.t("modal.capture_email.placeholder.email_content")).inputEl.style.height="200px"});let t=e.createDiv("modal-button-container");t.style.display="flex",t.style.justifyContent="space-between",t.style.marginTop="20px",t.createEl("button",{text:this.i18nService.t("modal.capture_email.cancel_button")},i=>{i.onclick=()=>{this.close()}}),t.createEl("button",{text:this.i18nService.t("modal.capture_email.capture_button"),cls:"mod-cta"},i=>{i.onclick=async()=>{await this.captureEmail()}}),setTimeout(()=>{this.senderInput.inputEl.focus()},100)}onClose(){let{contentEl:e}=this;e.empty()}validateEmail(e){let i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),r=this.senderInput.inputEl;return e&&!i?(r.style.borderColor="red",r.style.boxShadow="0 0 5px rgba(255, 0, 0, 0.3)"):(r.style.borderColor="",r.style.boxShadow=""),i}validateForm(){let e=[],t=this.senderInput.getValue().trim(),i=this.subjectInput.getValue().trim(),r=this.bodyInput.getValue().trim();return t?this.validateEmail(t)||e.push(this.i18nService.t("modal.capture_email.validation.sender_email_invalid")):e.push(this.i18nService.t("modal.capture_email.validation.sender_email_required")),i||e.push(this.i18nService.t("modal.capture_email.validation.subject_required")),r||e.push(this.i18nService.t("modal.capture_email.validation.content_required")),{isValid:e.length===0,errors:e}}async captureEmail(){try{let e=this.validateForm();if(!e.isValid){let a=e.errors.join(`
`);this.showError(`Please fix the following errors:

${a}`);return}let t={sender:this.senderInput.getValue().trim(),senderName:this.senderNameInput.getValue().trim()||void 0,subject:this.subjectInput.getValue().trim(),body:this.bodyInput.getValue().trim(),receivedDate:new Date().toISOString(),category:this.categoryDropdown.getValue()||void 0,priority:this.priorityDropdown.getValue()||"medium",tags:this.parseTags(this.tagsInput.getValue())},i=this.contentEl.querySelector(".mod-cta");i.textContent="Capturing...",i.disabled=!0;let r=await this.emailCaptureService.captureEmail(t);this.onSuccess(r),this.close()}catch(e){this.showError(`Failed to capture email: ${e instanceof Error?e.message:String(e)}`);let t=this.contentEl.querySelector(".mod-cta");t.textContent="Capture Email",t.disabled=!1}}parseTags(e){return e.split(",").map(t=>t.trim()).filter(t=>t.length>0)}showError(e){let t=this.contentEl.querySelector(".modal-error");t&&t.remove();let i=this.contentEl.createDiv("modal-error");i.style.color="red",i.style.backgroundColor="rgba(255, 0, 0, 0.1)",i.style.padding="10px",i.style.marginTop="10px",i.style.borderRadius="4px",i.style.border="1px solid red",i.textContent=e,setTimeout(()=>{i.parentNode&&i.remove()},5e3)}};var S=require("obsidian"),A=class extends S.Modal{constructor(t,i,r,a){super(t);this.settings=a;this.searchResults=[];this.currentQuery={query:""};this.searchDebounceTimer=null;this.isSearching=!1;this.searchService=i,this.i18n=r}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("knowledge-search-modal"),t.createEl("h2",{text:"\u77E5\u8B58\u30D9\u30FC\u30B9\u3092\u691C\u7D22"}),this.createSearchInput(t),this.createFiltersSection(t),this.resultsInfo=t.createEl("div",{cls:"search-results-info",text:"\u691C\u7D22\u3092\u958B\u59CB\u3057\u3066\u304F\u3060\u3055\u3044"}),this.resultsContainer=t.createEl("div",{cls:"search-results-container"}),this.initializeSearch(),this.searchInput.focus()}createSearchInput(t){let r=t.createEl("div",{cls:"search-input-section"}).createEl("div",{cls:"search-input-wrapper"});this.searchInput=r.createEl("input",{type:"text",placeholder:"\u30AD\u30FC\u30EF\u30FC\u30C9\u3092\u5165\u529B\u3057\u3066\u691C\u7D22...",cls:"search-input"});let a=r.createEl("button",{text:"\u691C\u7D22",cls:"search-button"});this.searchInput.addEventListener("input",()=>{this.debounceSearch()}),this.searchInput.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),this.performSearch()):s.key==="Escape"&&this.close()}),a.addEventListener("click",()=>{this.performSearch()})}createFiltersSection(t){let i=t.createEl("details",{cls:"filters-section"});i.createEl("summary",{text:"\u30D5\u30A3\u30EB\u30BF\u30FC\u30AA\u30D7\u30B7\u30E7\u30F3"});let r=i.createEl("div",{cls:"filters-content"}),a=r.createEl("div",{cls:"filter-group"});a.createEl("label",{text:"\u30AB\u30C6\u30B4\u30EA:"}),this.categoryFilter=a.createEl("select",{cls:"category-filter"}),this.categoryFilter.createEl("option",{value:"",text:"\u3059\u3079\u3066"});let n=[...["specification","issue","migration_vup","other"],...this.settings.customCategories||[]];for(let v of n)this.categoryFilter.createEl("option",{value:v,text:this.translateCategory(v)});let l=r.createEl("div",{cls:"filter-group"});l.createEl("label",{text:"\u65E5\u4ED8\u7BC4\u56F2:"});let o=l.createEl("div",{cls:"date-range-wrapper"});this.dateFromInput=o.createEl("input",{type:"date",cls:"date-input"}),o.createEl("span",{text:"\u301C"}),this.dateToInput=o.createEl("input",{type:"date",cls:"date-input"});let d=r.createEl("div",{cls:"filter-group"});d.createEl("label",{text:"\u691C\u7D22\u30AA\u30D7\u30B7\u30E7\u30F3:"});let c=d.createEl("div",{cls:"search-options"}),h=c.createEl("label",{cls:"option-label"});this.fuzzySearchToggle=h.createEl("input",{type:"checkbox",cls:"option-checkbox"}),h.createEl("span",{text:"\u3042\u3044\u307E\u3044\u691C\u7D22"});let u=c.createEl("label",{cls:"option-label"});this.searchInTitleToggle=u.createEl("input",{type:"checkbox",cls:"option-checkbox",value:"true"}),this.searchInTitleToggle.checked=!0,u.createEl("span",{text:"\u30BF\u30A4\u30C8\u30EB\u3092\u691C\u7D22"});let m=c.createEl("label",{cls:"option-label"});this.searchInContentToggle=m.createEl("input",{type:"checkbox",cls:"option-checkbox",value:"true"}),this.searchInContentToggle.checked=!0,m.createEl("span",{text:"\u5185\u5BB9\u3092\u691C\u7D22"}),this.categoryFilter.addEventListener("change",()=>this.performSearch()),this.dateFromInput.addEventListener("change",()=>this.performSearch()),this.dateToInput.addEventListener("change",()=>this.performSearch()),this.fuzzySearchToggle.addEventListener("change",()=>this.performSearch()),this.searchInTitleToggle.addEventListener("change",()=>this.performSearch()),this.searchInContentToggle.addEventListener("change",()=>this.performSearch())}async initializeSearch(){try{await this.searchService.initialize();let t=this.searchService.getStats();this.resultsInfo.setText(`${t.indexSize}\u4EF6\u306E\u77E5\u8B58\u30A8\u30F3\u30C8\u30EA\u304C\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u3055\u308C\u3066\u3044\u307E\u3059`)}catch(t){console.error("[KnowledgeSearch] Failed to initialize search:",t),this.resultsInfo.setText("\u691C\u7D22\u30B5\u30FC\u30D3\u30B9\u306E\u521D\u671F\u5316\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}}debounceSearch(){this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(()=>{this.performSearch()},300)}async performSearch(){if(!this.isSearching){this.currentQuery=this.buildSearchQuery(),this.isSearching=!0,this.resultsInfo.setText("\u691C\u7D22\u4E2D..."),this.resultsContainer.empty();try{let t=Date.now();this.searchResults=await this.searchService.search(this.currentQuery);let i=Date.now()-t;this.searchResults.length===0?this.resultsInfo.setText("\u691C\u7D22\u7D50\u679C\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F"):this.resultsInfo.setText(`${this.searchResults.length}\u4EF6\u306E\u7D50\u679C\u304C\u898B\u3064\u304B\u308A\u307E\u3057\u305F (${i}ms)`),this.displayResults()}catch(t){console.error("[KnowledgeSearch] Search failed:",t),this.resultsInfo.setText("\u691C\u7D22\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F"),new S.Notice("\u691C\u7D22\u306B\u5931\u6557\u3057\u307E\u3057\u305F: "+t)}finally{this.isSearching=!1}}}buildSearchQuery(){let t={query:this.searchInput.value.trim(),fuzzy:this.fuzzySearchToggle.checked,limit:50};this.categoryFilter.value&&(t.categories=[this.categoryFilter.value]),(this.dateFromInput.value||this.dateToInput.value)&&(t.dateRange={from:this.dateFromInput.value?new Date(this.dateFromInput.value):new Date(0),to:this.dateToInput.value?new Date(this.dateToInput.value):new Date});let i=[];return this.searchInTitleToggle.checked&&i.push("title"),this.searchInContentToggle.checked&&i.push("content"),i.length===0||i.length===2?t.searchIn=["all"]:t.searchIn=i,t}displayResults(){if(this.resultsContainer.empty(),this.searchResults.length===0){this.resultsContainer.createEl("div",{cls:"no-results",text:"\u691C\u7D22\u6761\u4EF6\u306B\u4E00\u81F4\u3059\u308B\u77E5\u8B58\u30A8\u30F3\u30C8\u30EA\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F"});return}let t=this.resultsContainer.createEl("div",{cls:"results-list"});for(let i of this.searchResults)this.createResultItem(t,i)}createResultItem(t,i){let r=t.createEl("div",{cls:"result-item"}),a=r.createEl("div",{cls:"result-header"}),s=a.createEl("div",{cls:"result-title-wrapper"}),n=s.createEl("a",{cls:"result-title",text:i.title,href:"#"});i.relevanceScore>70?s.createEl("span",{cls:"relevance-badge high",text:`${i.relevanceScore}%`}):i.relevanceScore>40&&s.createEl("span",{cls:"relevance-badge medium",text:`${i.relevanceScore}%`});let l=a.createEl("div",{cls:"result-metadata"});if(l.createEl("span",{cls:"result-category",text:this.translateCategory(i.category)}),i.tags.length>0){let c=l.createEl("span",{cls:"result-tags"});for(let h of i.tags.slice(0,3))c.createEl("span",{cls:"tag",text:h})}let o=r.createEl("div",{cls:"result-excerpt"});if(o.innerHTML=this.sanitizeHtml(i.excerpt),i.matchedFields.length>0){let c=r.createEl("div",{cls:"result-match-info",text:`\u30DE\u30C3\u30C1: ${i.matchedFields.map(h=>this.translateField(h)).join(", ")}`})}let d=r.createEl("div",{cls:"result-date",text:`\u4F5C\u6210: ${this.formatDate(i.createdAt)}`});n.addEventListener("click",c=>{c.preventDefault(),this.openKnowledgeEntry(i)}),r.tabIndex=0,r.addEventListener("keydown",c=>{c.key==="Enter"&&this.openKnowledgeEntry(i)})}async openKnowledgeEntry(t){try{let i=this.app.vault.getAbstractFileByPath(t.filePath);if(!i&&t.filePath.startsWith("/")){let r=t.filePath.substring(1);i=this.app.vault.getAbstractFileByPath(r)}if(!i){let r=`${this.settings.knowledgeFolder}/${t.filePath}`;i=this.app.vault.getAbstractFileByPath(r)}i instanceof S.TFile?(this.close(),await this.app.workspace.getLeaf(!1).openFile(i),new S.Notice(`\u77E5\u8B58\u30A8\u30F3\u30C8\u30EA\u3092\u958B\u304D\u307E\u3057\u305F: ${t.title}`)):new S.Notice("\u30D5\u30A1\u30A4\u30EB\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093: "+t.filePath)}catch(i){console.error("[KnowledgeSearch] Failed to open file:",i),new S.Notice("\u30D5\u30A1\u30A4\u30EB\u3092\u958B\u3051\u307E\u305B\u3093\u3067\u3057\u305F")}}translateCategory(t){return{specification:"\u4ED5\u69D8",issue:"\u969C\u5BB3",migration_vup:"\u79FB\u884C/VUP",other:"\u305D\u306E\u4ED6"}[t]||t}translateField(t){return{title:"\u30BF\u30A4\u30C8\u30EB",content:"\u5185\u5BB9",problem:"\u554F\u984C",solution:"\u89E3\u6C7A\u65B9\u6CD5",tags:"\u30BF\u30B0",category:"\u30AB\u30C6\u30B4\u30EA",keywords:"\u30AD\u30FC\u30EF\u30FC\u30C9"}[t]||t}formatDate(t){let i=new Date(t);return`${i.getFullYear()}/${String(i.getMonth()+1).padStart(2,"0")}/${String(i.getDate()).padStart(2,"0")}`}sanitizeHtml(t){return t.replace(/<script[^>]*>.*?<\/script>/gi,"").replace(/<iframe[^>]*>.*?<\/iframe>/gi,"").replace(/on\w+="[^"]*"/gi,"").replace(/on\w+='[^']*'/gi,"")}onClose(){let{contentEl:t}=this;t.empty(),this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer)}};var y=require("obsidian");var P=class extends y.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty();let t=this.plugin.getI18nService();e.createEl("h2",{text:t.t("settings.title")}),e.createEl("h3",{text:t.t("settings.folders.title")}),new y.Setting(e).setName(t.t("settings.folders.emails_folder")).setDesc(t.t("settings.folders.emails_folder_desc")).addText(a=>a.setPlaceholder("Emails").setValue(this.plugin.settings.emailsFolder).onChange(async s=>{this.plugin.settings.emailsFolder=s||"Emails",await this.plugin.saveSettings()})),new y.Setting(e).setName(t.t("settings.folders.summaries_folder")).setDesc(t.t("settings.folders.summaries_folder_desc")).addText(a=>a.setPlaceholder("Summaries").setValue(this.plugin.settings.summariesFolder).onChange(async s=>{this.plugin.settings.summariesFolder=s||"Summaries",await this.plugin.saveSettings()})),new y.Setting(e).setName(t.t("settings.folders.knowledge_folder")).setDesc(t.t("settings.folders.knowledge_folder_desc")).addText(a=>a.setPlaceholder("Knowledge").setValue(this.plugin.settings.knowledgeFolder).onChange(async s=>{this.plugin.settings.knowledgeFolder=s||"Knowledge",await this.plugin.saveSettings()})),e.createEl("h3",{text:t.t("settings.defaults.title")}),new y.Setting(e).setName(t.t("settings.defaults.category")).setDesc(t.t("settings.defaults.category_desc")).addDropdown(a=>{let s=t.getTranslationGroup("categories");a.addOption("specification",s.specification).addOption("issue",s.issue).addOption("migration_vup",s.migration_vup).addOption("other",s.other),this.plugin.settings.customCategories&&this.plugin.settings.customCategories.length>0&&this.plugin.settings.customCategories.forEach(n=>{a.addOption(n,n)}),a.setValue(this.plugin.settings.defaultCategory).onChange(async n=>{this.plugin.settings.defaultCategory=n,await this.plugin.saveSettings()})}),new y.Setting(e).setName(t.t("settings.defaults.priority")).setDesc(t.t("settings.defaults.priority_desc")).addDropdown(a=>{let s=t.getTranslationGroup("priorities");a.addOption("low",s.low).addOption("medium",s.medium).addOption("high",s.high).addOption("urgent",s.urgent).setValue(this.plugin.settings.defaultPriority).onChange(async n=>{this.plugin.settings.defaultPriority=n,await this.plugin.saveSettings()})}),e.createEl("h3",{text:t.t("settings.automation.title")}),new y.Setting(e).setName(t.t("settings.automation.auto_summary")).setDesc(t.t("settings.automation.auto_summary_desc")).addToggle(a=>a.setValue(this.plugin.settings.autoGenerateSummary).onChange(async s=>{this.plugin.settings.autoGenerateSummary=s,await this.plugin.saveSettings()})),new y.Setting(e).setName(t.t("settings.automation.auto_knowledge")).setDesc(t.t("settings.automation.auto_knowledge_desc")).addToggle(a=>a.setValue(this.plugin.settings.autoExtractKnowledge).onChange(async s=>{this.plugin.settings.autoExtractKnowledge=s,await this.plugin.saveSettings()})),new y.Setting(e).setName(t.t("settings.automation.enable_notifications")).setDesc(t.t("settings.automation.enable_notifications_desc")).addToggle(a=>a.setValue(this.plugin.settings.enableNotifications).onChange(async s=>{this.plugin.settings.enableNotifications=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:t.t("settings.categories.title")});let i=e.createDiv("custom-categories-container");i.style.marginBottom="15px";let r=i.createEl("p",{text:t.t("settings.categories.manage_desc"),cls:"setting-item-description"});r.style.marginBottom="8px",r.style.color="var(--text-muted)",r.style.fontSize="13px",this.displayCustomCategories(i,t),new y.Setting(e).setName(t.t("settings.categories.add_category")).setDesc(t.t("settings.categories.add_category_desc")).addText(a=>{a.setPlaceholder(t.t("settings.categories.category_placeholder"));let s=e.createEl("button",{text:t.t("settings.categories.add_button"),cls:"mod-cta"});s.style.marginLeft="10px",s.onclick=async()=>{let n=a.getValue().trim();n&&!this.plugin.settings.customCategories.includes(n)&&(this.plugin.settings.customCategories.push(n),await this.plugin.saveSettings(),a.setValue(""),this.displayCustomCategories(i,t))},a.inputEl.parentElement?.appendChild(s)}),e.createEl("h3",{text:t.t("settings.advanced.title")}),new y.Setting(e).setName(t.t("settings.advanced.language")).setDesc(t.t("settings.advanced.language_desc")).addDropdown(a=>{let s=t.getTranslationGroup("languages");a.addOption("en",s.en).addOption("ja",s.ja).setValue(this.plugin.settings.language).onChange(async n=>{this.plugin.settings.language=n,await this.plugin.saveSettings(),this.display()})}),new y.Setting(e).setName(t.t("settings.advanced.max_attachment_size")).setDesc(t.t("settings.advanced.max_attachment_size_desc")).addText(a=>a.setPlaceholder("10").setValue(String(this.plugin.settings.maxAttachmentSize/(1024*1024))).onChange(async s=>{let n=parseFloat(s)||10;this.plugin.settings.maxAttachmentSize=n*1024*1024,await this.plugin.saveSettings()})),new y.Setting(e).setName("Reset Settings").setDesc("Reset all settings to default values").addButton(a=>a.setButtonText("Reset to Defaults").setWarning().onClick(async()=>{window.confirm("Are you sure you want to reset all settings to default values? This cannot be undone.")&&(this.plugin.settings={emailsFolder:"Emails",summariesFolder:"Summaries",knowledgeFolder:"Knowledge",defaultCategory:"specification",defaultPriority:"medium",autoGenerateSummary:!0,autoExtractKnowledge:!1,enableNotifications:!0,maxAttachmentSize:10*1024*1024,language:"en",customCategories:[]},await this.plugin.saveSettings(),this.display())})),e.createEl("h3",{text:"About"}),e.createEl("p",{text:"Email Inquiry Management Plugin v1.0.0 - Capture, organize, and build knowledge from email inquiries."})}displayCustomCategories(e,t){if(e.empty(),this.plugin.settings.customCategories.length===0){e.createEl("p",{text:t.t("settings.categories.no_custom_categories"),cls:"setting-item-description"});return}let i=e.createEl("div",{cls:"custom-categories-list"});i.style.display="flex",i.style.flexWrap="wrap",i.style.gap="8px",i.style.marginTop="8px",this.plugin.settings.customCategories.forEach((r,a)=>{let s=i.createEl("span",{text:r,cls:"category-tag"});s.style.backgroundColor="var(--interactive-accent)",s.style.color="var(--text-on-accent)",s.style.padding="4px 8px",s.style.borderRadius="12px",s.style.fontSize="12px",s.style.display="inline-flex",s.style.alignItems="center",s.style.gap="4px";let n=s.createEl("span",{text:"\xD7",cls:"category-remove"});n.style.cursor="pointer",n.style.fontWeight="bold",n.style.marginLeft="4px",n.style.opacity="0.8",n.style.fontSize="14px",n.style.lineHeight="1",n.style.width="16px",n.style.height="16px",n.style.display="inline-flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.borderRadius="50%",n.style.transition="all 0.2s ease",n.title=t.t("settings.categories.delete_tooltip"),n.addEventListener("mouseenter",()=>{n.style.opacity="1",n.style.backgroundColor="rgba(255, 255, 255, 0.2)",n.style.transform="scale(1.1)"}),n.addEventListener("mouseleave",()=>{n.style.opacity="0.8",n.style.backgroundColor="transparent",n.style.transform="scale(1)"}),n.onclick=async()=>{window.confirm(t.t("settings.categories.delete_confirm",{category:r}))&&(this.plugin.settings.customCategories.splice(a,1),await this.plugin.saveSettings(),this.displayCustomCategories(e,t))}})}};var X={emailsFolder:"Emails",summariesFolder:"Summaries",knowledgeFolder:"Knowledge",defaultCategory:"specification",defaultPriority:"medium",autoGenerateSummary:!0,autoExtractKnowledge:!1,enableNotifications:!0,maxAttachmentSize:10*1024*1024,language:"en",customCategories:[]},I=class extends p.Plugin{async onload(){console.log("Loading Email Inquiry Plugin"),await this.loadSettings(),this.i18nService=new $,await this.i18nService.initialize(),this.i18nService.setLanguage(this.settings.language),this.vaultAdapter=new T(this.app.vault,this.app.fileManager),this.knowledgeExtractionService=new D(this.vaultAdapter,{knowledgeFolder:this.settings.knowledgeFolder,autoExtractKnowledge:this.settings.autoExtractKnowledge,enableNotifications:this.settings.enableNotifications}),this.dailySummaryService=new F(this.vaultAdapter,{summariesFolder:this.settings.summariesFolder,emailsFolder:this.settings.emailsFolder,language:this.settings.language}),this.knowledgeSearchService=new C(this.vaultAdapter,{knowledgeFolder:this.settings.knowledgeFolder,enableCache:!0,maxResults:50}),this.emailCaptureService=new b(this.vaultAdapter,this.settings.emailsFolder,void 0,this.knowledgeExtractionService),this.addSettingTab(new P(this.app,this)),this.registerCommands(),this.addRibbonIcon("mail",this.i18nService.t("ribbon.capture_email"),()=>{this.openEmailCaptureModal()}),console.log("[EmailInquiry] Plugin loaded successfully with settings:",{emailsFolder:this.settings.emailsFolder,summariesFolder:this.settings.summariesFolder,knowledgeFolder:this.settings.knowledgeFolder,autoExtractKnowledge:this.settings.autoExtractKnowledge,language:this.settings.language})}onunload(){console.log("Unloading Email Inquiry Plugin")}async loadSettings(){this.settings=Object.assign({},X,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.i18nService&&this.i18nService.setLanguage(this.settings.language),this.vaultAdapter&&(this.knowledgeExtractionService.updateSettings({knowledgeFolder:this.settings.knowledgeFolder,autoExtractKnowledge:this.settings.autoExtractKnowledge,enableNotifications:this.settings.enableNotifications}),this.dailySummaryService.updateSettings({summariesFolder:this.settings.summariesFolder,emailsFolder:this.settings.emailsFolder,language:this.settings.language}),this.emailCaptureService=new b(this.vaultAdapter,this.settings.emailsFolder,void 0,this.knowledgeExtractionService)),console.log("[EmailInquiry] Settings updated:",{emailsFolder:this.settings.emailsFolder,knowledgeFolder:this.settings.knowledgeFolder,autoExtractKnowledge:this.settings.autoExtractKnowledge})}registerCommands(){this.addCommand({id:"capture-email",name:this.i18nService.t("commands.capture_email"),callback:()=>{this.openEmailCaptureModal()}}),this.addCommand({id:"generate-daily-summary",name:this.i18nService.t("commands.generate_daily_summary"),callback:()=>{this.generateDailySummary()}}),this.addCommand({id:"search-knowledge-base",name:this.i18nService.t("commands.search_knowledge_base"),callback:()=>{this.openKnowledgeSearch()}}),this.addCommand({id:"bulk-import-emails",name:this.i18nService.t("commands.bulk_import_emails"),callback:()=>{this.openBulkImportModal()}}),this.addCommand({id:"extract-knowledge-from-email",name:"\u73FE\u5728\u306E\u30E1\u30FC\u30EB\u304B\u3089\u30CA\u30EC\u30C3\u30B8\u3092\u62BD\u51FA",callback:()=>{this.extractKnowledgeFromCurrentEmail()}})}openEmailCaptureModal(){new k(this.app,this.emailCaptureService,this.settings,this.i18nService,e=>{this.settings.enableNotifications&&new p.Notice(this.i18nService.t("notices.email_captured",{path:e.path}))}).open()}async generateDailySummary(){try{let e=new Date().toISOString().split("T")[0];console.log(`[EmailInquiry] Generating daily summary for: ${e}`),new p.Notice(this.i18nService.t("notices.generating_summary",{date:e}));let t=await this.dailySummaryService.generateSummary({date:e,includePreviousDays:0});this.settings.enableNotifications?new p.Notice(this.i18nService.t("notices.summary_generated_with_path",{path:t.filePath,count:t.stats.totalEmails})):new p.Notice(this.i18nService.t("notices.summary_generated")),console.log("[EmailInquiry] Daily summary generated successfully:",t)}catch(e){console.error("[EmailInquiry] Daily summary generation failed:",e),new p.Notice(this.i18nService.t("notices.error_generating_summary",{error:String(e)}))}}openKnowledgeSearch(){new A(this.app,this.knowledgeSearchService,this.i18nService,{knowledgeFolder:this.settings.knowledgeFolder,customCategories:this.settings.customCategories}).open()}openBulkImportModal(){new p.Notice(this.i18nService.t("notices.bulk_import_coming_soon"))}async extractKnowledgeFromCurrentEmail(){try{let e=this.app.workspace.getActiveFile();if(!e){new p.Notice("\u30D5\u30A1\u30A4\u30EB\u304C\u9078\u629E\u3055\u308C\u3066\u3044\u307E\u305B\u3093");return}if(!e.path.startsWith(this.settings.emailsFolder)){new p.Notice("\u30E1\u30FC\u30EB\u30D5\u30A9\u30EB\u30C0\u5185\u306E\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044");return}if(!e.path.endsWith(".md")){new p.Notice("Markdown\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044");return}new p.Notice("\u30CA\u30EC\u30C3\u30B8\u62BD\u51FA\u3092\u958B\u59CB\u3057\u3066\u3044\u307E\u3059..."),console.log(`[EmailInquiry] Extracting knowledge from: ${e.path}`);let t=await this.knowledgeExtractionService.extractKnowledgeFromFile(e.path);t?(new p.Notice(`\u30CA\u30EC\u30C3\u30B8\u304C\u62BD\u51FA\u3055\u308C\u307E\u3057\u305F: ${t}`),console.log(`[EmailInquiry] Knowledge extracted successfully: ${t}`)):(new p.Notice("\u30CA\u30EC\u30C3\u30B8\u62BD\u51FA\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u30E1\u30FC\u30EB\u304C\u89E3\u6C7A\u6E08\u307F\u304B\u78BA\u8A8D\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),console.log("[EmailInquiry] No knowledge extracted - email may not be resolved or eligible"))}catch(e){console.error("[EmailInquiry] Knowledge extraction failed:",e),new p.Notice(`\u30CA\u30EC\u30C3\u30B8\u62BD\u51FA\u30A8\u30E9\u30FC: ${e instanceof Error?e.message:String(e)}`)}}getEmailsFolder(){return this.settings.emailsFolder}getSummariesFolder(){return this.settings.summariesFolder}getKnowledgeFolder(){return this.settings.knowledgeFolder}getI18nService(){return this.i18nService}};
