# 調査結果: Obsidianメール問い合わせ管理システム

**日付**: 2025-09-05  
**機能**: 002-obsidian-email-inquiry

## 概要
Obsidianメール問い合わせ管理プラグインの技術アプローチを確立し、仕様書の明確化項目を解決するために実施した調査。仕様書のすべての要確認事項が具体的な決定により対処されました。

## 明確化項目の解決

### 1. メールフィールド抽出 (FR-006)
**決定**: 送信者、件名、日付、本文、添付ファイルリスト、カスタムタグを抽出  
**根拠**: これらは問い合わせ管理に十分なコンテキストを提供する標準的なメールフィールドです  
**検討した代替案**: 
- フルヘッダー抽出（拒否 - ユーザーニーズに対して複雑すぎる）
- 本文のみ抽出（拒否 - 重要なコンテキストを失う）

### 2. メールスレッドグループ化 (FR-009)
**決定**: 件名の類似性とIn-Reply-Toヘッダー（利用可能時）でグループ化  
**根拠**: ユーザーが期待する標準的なメールスレッド化アプローチ  
**検討した代替案**:
- グループ化なし（拒否 - 会話コンテキストを失う）
- 時間ベースグループ化（拒否 - 無関係なメールを誤ってグループ化する可能性）

### 3. 一括インポートソース (FR-010)
**決定**: .emlファイル、.mboxアーカイブ、CSVエクスポートをサポート  
**根拠**: 最も一般的なメールエクスポート形式をカバー  
**検討した代替案**:
- 直接IMAP接続（拒否 - セキュリティの複雑性）
- コピー＆ペーストのみ（拒否 - 一括操作には非効率）

### 4. 問い合わせ統計 (FR-011)
**決定**: 日次/週次/月次ボリューム、トップカテゴリ、平均解決時間、共通キーワードを追跡  
**根拠**: ユーザーを圧倒することなく実用的な洞察を提供  
**検討した代替案**:
- 単純なカウントのみ（拒否 - パターン検出には不十分）
- 複雑な分析（拒否 - プラグインスコープ外）

### 5. データ保持 (FR-013)
**決定**: 無期限保持、1年後にオプションでアーカイブ  
**根拠**: Obsidianユーザーは永続的なノートを期待、アーカイブはボルトを管理可能に保つ  
**検討した代替案**:
- 期間後の自動削除（拒否 - データ損失リスク）
- アーカイブなし（拒否 - 大容量でのパフォーマンス影響）

### 6. 予想ボリューム (FR-014)
**決定**: 1日50-100メールに最適化、最大500/日までテスト  
**根拠**: 余裕を持った一般的なサポートチームボリュームをカバー  
**検討した代替案**:
- より低い制限（拒否 - 制限が厳しすぎる）
- より高い制限（拒否 - 異なるアーキテクチャが必要）

## 技術調査

### Obsidianプラグインアーキテクチャ
**決定**: TypeScriptでObsidian Plugin API 1.4+を使用  
**根拠**: 良好なドキュメンテーションを持つ公式サポートアプローチ  
**主要発見事項**:
- プラグインはNode.jsアクセス可能なElectron環境で動作
- カスタムビュー、コマンド、設定を作成可能
- Vault API経由でファイル操作
- MetadataCache API経由で検索

### メール解析アプローチ
**決定**: .eml用mailparserライブラリ、.mbox用node-mboxを使用  
**根拠**: 優れたエンコーディングサポートを持つ成熟したライブラリ  
**主要発見事項**:
- 様々なエンコーディング（UTF-8、ISO-8859-1など）を処理
- 添付ファイルを別ノートとして抽出
- HTML構造をマークダウンとして保持

### マークダウンフロントマタースキーマ
**決定**: 標準化フィールドを持つYAMLフロントマター  
**根拠**: Obsidianのネイティブサポート、Dataview経由でクエリ可能  
**スキーマ**:
```yaml
---
email-id: unique-identifier
sender: email@example.com
subject: Email Subject
date: 2025-09-05T10:30:00Z
status: pending|resolved|archived
tags: [tag1, tag2]
category: support|sales|other
thread-id: thread-identifier
---
```

### 日次サマリー生成
**決定**: オンデマンド生成される仮想ファイル、パフォーマンス用にキャッシュ  
**根拠**: 迅速なアクセスを提供しながら重複データを回避  
**主要発見事項**:
- 集約にDataviewクエリを使用
- 結果を5分間キャッシュ
- メールステータス変更時に再生成

### ナレッジベースインデックス化
**決定**: カスタム演算子付きのObsidianの組み込み検索を使用  
**根拠**: 既存の検索UIとインデックス化を活用  
**実装**:
- タグベース分類
- リンクベース関係
- メール本文の全文検索

### パフォーマンス最適化
**決定**: 遅延読み込み、ページネーション、増分インデックス化  
**根拠**: 大きなボルトで応答性を維持  
**戦略**:
- メールを50件ずつバッチで読み込み
- 作成時に新しいメールをインデックス化
- 一括インポート用バックグラウンド処理

## 特定されたベストプラクティス

### Obsidianプラグイン開発
1. UIコンポーネントにWorkspace APIを使用
2. 構成用設定タブを実装
3. リアルタイム更新用ボルトイベントを処理
4. コマンドパレットアクションを提供
5. モバイルとデスクトッププラットフォームをサポート

### データ組織
1. アトミック更新のためメール1通につき1ノート
2. フォルダ構造: /Emails/YYYY/MM/DD/
3. ナレッジエントリ用別フォルダ
4. 横断的分類用タグ

### ユーザーエクスペリエンス
1. メールインポート用ドラッグ＆ドロップ
2. ホットキー経由のクイック取り込み
3. 解決ノート用テンプレートサポート
4. 分類用一括アクション

## リスク軽減

### パフォーマンスリスク
- **リスク**: 大量のメールがボルトを遅くする
- **軽減策**: ページネーションと遅延読み込みの実装

### データ整合性
- **リスク**: 破損したメールインポートでデータ損失  
- **軽減策**: インポート前の検証、元ファイルのバックアップ

### 検索パフォーマンス
- **リスク**: 全文検索が遅くなる
- **軽減策**: フロントマターのインデックス化フィールドを使用

## 結論
すべての仕様明確化項目が具体的な技術決定により解決されました。調査により、Obsidianのプラグインアーキテクチャ内ですべての機能要件を実装することの実現可能性が確認されました。アプローチはメール問い合わせ管理のユーザーニーズを満たしながら、シンプリシティとパフォーマンスを優先します。

## 次のステップ
1. 決定に基づく詳細データモデルの作成
2. プラグインAPI契約の定義
3. 要件からのテストシナリオ生成
4. ユーザー向けクイックスタートガイドの構築